- name: configure Oracle agent
  hosts: localhost
  connection: local

  tasks:
    - name: qlogin
      shell: /opt/commvault/Base/qlogin  -u cvadmin -ps 3986b7eba48f68df5008a977179c3615dfbfa6ab8c1bd9938

    - name: create Oracle instance
      shell: /opt/commvault/Base/qoperation execute -af /home/adminuser/automation/resources/CreateInstance_Template.xml -appName oracle -clientName oraclevm2 -instanceName testdb -logBackupStoragePolicy/storagePolicyName SP6_maazure2 -oracleHome /u01/app/oracle/product/12.1.0/dbhome_1 -commandLineStoragePolicy/storagePolicyName SP6_maazure2 -oracleUser/userName oracle -sqlConnect/userName / -useCatalogConnect false
      ignore_errors: yes

    - name: create DB subclient
      shell: /opt/commvault/Base/qoperation execute -af /home/adminuser/automation/resources/create_subclient_template.xml -appName Oracle -clientName oraclevm2 -instanceName testdb -subclientName Online -data true -backupMode ONLINE_DB -dataBackupStoragePolicy/storagePolicyName SP6_maazure2

    - name: create LogOnly subclient
      shell: /opt/commvault/Base/qoperation execute -af /home/adminuser/automation/resources/create_subclient_template.xml -appName Oracle -clientName oraclevm2 -instanceName testdb -subclientName Logonly -data false -backupArchiveLog true -archiveDelete true -dataBackupStoragePolicy/storagePolicyName SP6_maazure2 -disableSwitchCurrentLog true

    - name: add Online subclient to schedule policy
      shell: /opt/commvault/Base/qoperation execute -af /home/adminuser/automation/resources/schedule_policies_edit.xml -task/taskName AutomationTest -taskType SCHEDULE_POLICY -associations/clientName oraclevm2 -associations/appName Oracle -associations/instanceName testdb -associations/subclientName Online -include 1 -taskOperation MODIFY

    - name: add LogOnly subclient to schedule policy
      shell: /opt/commvault/Base/qoperation execute -af /home/adminuser/automation/resources/schedule_policies_edit.xml -task/taskName AutomationTest_Logonly -taskType SCHEDULE_POLICY -associations/clientName oraclevm2 -associations/appName Oracle -associations/instanceName testdb -associations/subclientName Logonly -include 1 -taskOperation MODIFY

    - name: start full Online backup
      shell: /opt/commvault/Base/qoperation execute -af /home/adminuser/automation/resources/backup_template.xml -appName 'Oracle' -clientName oraclevm2 -instanceName testdb -subclientName Online -backupLevel 'FULL'

    - name: qlogout
      shell: /opt/commvault/Base/qlogout
